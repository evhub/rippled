from __future__ import absolute_import, division, print_function, unicode_literals

import curses
import ntpath
import os
import sys
import textwrap

def add_beast_to_path():
  python_home = os.path.join(os.getcwd(), 'python')
  if python_home not in sys.path:
    sys.path.append(python_home)

add_beast_to_path()

from beast.util import Boost
from beast.util import String
from beast.util import Terminal
from beast.util import Tests

ENVIRONMENT_VARIABLES = {
  'BOOST_HOME': None,
  'CC': '',
  'CCFLAGS': '',
  'CFLAGS': '',
  'CPPFLAGS': None,
  'CXX': 'clang++',
  'CXXFLAGS': '-x c++ -stdlib=libc++ -std=c++11 -frtti -g',
  'LIBPATH': '',
  'LIBS': '',
  'LINKFLAGS': '-stdlib=libc++',
  }

VARIANT_DIRECTORIES = {
    'beast': ('bin', 'beast'),
    'modules': ('bin', 'modules'),
}

MAIN_PROGRAM_FILE = 'beast/unit_test/tests/main.cpp'
FIELD_WIDTH = 10

EMPTY_NAME = ' ' * FIELD_WIDTH

TEXT_WRAPPER = textwrap.TextWrapper(
    break_long_words=False,
    break_on_hyphens=False,
    width=69,
)

DISPLAY_EMPTY_ENVS = True

def print_build_vars(env, name, value):
    """Pretty-print values as a build configuration."""
    name = '%s' % name.rjust(FIELD_WIDTH)

    for line in TEXT_WRAPPER.wrap(String.join(value, ' ')):
        print(' '.join([name, Terminal.blue(line)]))
        name = EMPTY_NAME

def print_build_config(env):
    print('\nConfiguration:')
    for name, default in ENVIRONMENT_VARIABLES.items():
        value = env.get(name)
        if value or DISPLAY_EMPTY_ENVS:
           print_build_vars(env, name, value)
    print()

def print_cmd_line(s, target, source, env):
    print(EMPTY_NAME + Terminal.blue(String.join(target)))

def make_env():
    env = Environment()

    env['PRINT_CMD_LINE_FUNC'] = print_cmd_line

    for name, path in VARIANT_DIRECTORIES.items():
        env.VariantDir(os.path.join(*path), name, duplicate=0)

    # Copy important os environment variables into env
    replacements = {}
    for name, default in ENVIRONMENT_VARIABLES.items():
        value = os.environ.get(name, default)
        if value:
            replacements[name] = value
    env.Replace(**replacements)
    env['CCCOMSTR'] = 'Compiling $TARGET'
    env['LINKCOMSTR'] = 'Linking $TARGET'
    boost = Boost.boost_path()
    env.Prepend(CPPPATH=boost)
    env.Append(LIBPATH=os.path.join(boost, 'stage', 'lib'))

    return env

def main():
    env = make_env()
    print_build_config(env)
    Tests.run_tests(env, MAIN_PROGRAM_FILE, '.', '.test.cpp')

main()
